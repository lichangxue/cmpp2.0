<!DOCTYPE html>
<html>
<head>
    
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-touch-fullscreen" content="yes"/>
    <meta name="format-detection" content="email=no" />
    <meta name="wap-font-scale"  content="no" />
    <meta name="viewport" content="user-scalable=no, width=device-width" />
    <meta content="telephone=no" name="format-detection" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <title>登录-CMPP 2.0</title>
    <meta name="description" content="">
    <meta name="keywords" content="">

    <link href="/i/axui-v2.1.1/css/ax.min.css" rel="stylesheet" type="text/css" >
    <link href="/i/axui-v2.1.1/css/ax-response.css" rel="stylesheet" type="text/css" >
    <link href="/i/public/css/main.css" rel="stylesheet" type="text/css">
</head>

<body class="ax-align-origin">
    <div class="login ax-shadow-cloud ax-radius-md">
        <div class="ax-alert" theme="primary">CMPP 系统不支持在线注册，如有使用需要，请邮件发送给lichangxue@renbenzhihui.com申请开通</div>
        <div class="ax-row ax-radius-md ax-split">
            <div class="ax-col ax-col-14 ax-radius-left ax-radius-md cover"></div>
            <div class="ax-col ax-col-10">
                <div class="core">
                    
                    <div class="ax-break"></div>

                    <div class="ax-tab" axTab>

                        <ul class="ax-lamp-group ax-tab-header">
                            <li>手机号登录</li>
                        </ul>

                        <ul class="ax-tab-body">
                            <li>
                                <form>

                                    <div class="ax-break"></div>
                                    <div class="ax-break ax-hide-tel"></div>

                                    <div class="ax-form-group">
                                        <div class="ax-flex-row">
                                            <div class="ax-form-con">
                                                <div class="ax-form-input">
                                                    <span class="ax-pos-left" style="width: 2.4rem;">
                                                        <i class="ax-iconfont ax-icon-me-f"></i>
                                                    </span>
                                                    <input name="mobile" id="mobile"  axValid='type:"telephone,required"' placeholder="输入手机号码" type="text">
                                                    <span class="ax-pos-right">
                                                        <a href="###" class="ax-iconfont ax-icon-close ax-val-none"></a>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="ax-break-md"></div>

                                    <div class="ax-form-group">
                                        <div class="ax-flex-row">
                                            <div class="ax-form-con">
                                                <div class="ax-form-input">
                                                    <div class="ax-row">
                                                        <div class="ax-flex-block">
                                                            <span class="ax-pos-left" style="width:2.4rem;"><i class="ax-iconfont ax-icon-shield-f"></i></span>
                                                            <input name="imgcode" id="imgcode" axValid='type:"string,required,length",length:4' placeholder="输入验证码..." value="" type="text"><span class="ax-pos-right"><a href="###" class="ax-iconfont ax-icon-close ax-val-none"></a></span>
                                                        </div>
                                                        <a href="###" class="ax-form-img"><img id="imgcodeshow" src=""></a>
                                                    </div>
                                                </div>

                                            </div>
                                        </div>
                                    </div>

                                    <div class="ax-break-md"></div>

                                    <div class="ax-form-group">
                                        <div class="ax-flex-row">
                                            <div class="ax-form-con">
                                                <div class="ax-form-input">
                                                    <div class="ax-row">
                                                        <div class="ax-flex-block">
                                                            <span class="ax-pos-left" style="width:2.4rem;"><i class="ax-iconfont ax-icon-lock-f"></i></span>
                                                            <input name="code" id="code" placeholder="输入手机验证码" axValid='type:"string,required,length",length:6' type="text"><span class="ax-pos-right"><a href="###" class="ax-iconfont ax-icon-close ax-val-none"></a></span>
                                                        </div>
                                                        <div class="ax-form-img"><button type="button" class="ax-btn ax-question ax-full sendCode">发送验证码</button></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>                                    

                                    <div class="ax-break-md"></div>

                                    <div class="ax-form-group">
                                        <div class="ax-flex-row">
                                            <div class="ax-flex-block">
                                                <div class="ax-form-input"><button type="button" class="ax-btn ax-primary ax-full mobileLogin">登录</button></div>
                                            </div>
                                        </div>
                                    </div>

                                    
                                    <div class="ax-break"></div>
                                    <div class="ax-break ax-hide-tel"></div>
                                    <div class="ax-break ax-hide-tel"></div>

                                </form>
                            </li>
                            
                        </ul>
                    </div>
                </div>
                
            </div>
        </div>
    </div>

    <!--正文结束-->

    <div class="footer">
        &#xa9; 2024 <a href="https://www.renbenai.com/" target="_self">Renbenai.com</a> 人本智汇 版权所有 
    </div>

    <script src="/i/axui-v2.1.1/js/ax.min.js" type="text/javascript"></script>
    <script src="/i/public/js/jquery-3.7.1.min.js" charset="utf-8"></script>
    <script src="/i/public/js/jquery.cookie.js" charset="utf-8"></script>  
    <script>
        console.log('sdfsdfsd')
        $(function(){
            function loadCaptcha(){
                
                //获取验证码
                $.ajax({
                    url: '<{url c="system" a="sendReq"}>', // 设置请求URL
                    type: "POST", // 指定请求类型为POST
                    dataType: "json", // 设置返回数据格式为JSON
                    contentType: 'application/json', // 设置请求头中Content-Type字段值为'application/json'
                    data: JSON.stringify({"api":"/api/auth/captcha","method":"get"}), // 将要发送的数据转换成JSON字符串并作为参数传递
                    success: function (response) {
                        if(response.status/1 == 0){
                            $('#imgcodeshow').attr("src","data:image/png;base64,"+response.data.captchaImage)
                            $.cookie('cmpp_sessionid', response.data.sessionId, {expires: 30,path:'/'});
                        }else{
                            new axMessage({
                                content: response.msg,
                                result: 'error',
                                iconShow:true,
                            }).show();
                        
                        }
                    },
                    error: function () {
                        new axMessage({
                            content: '图形验证码请求失败',
                            result: 'error',
                            iconShow:true,
                        }).show();
                    }
                });
            }
            loadCaptcha()
            $('#imgcodeshow').click(function(){
                loadCaptcha()
            })
            $('.sendCode').click(function(){
                var mobile = $('#mobile').val();
                var imgcode = $('#imgcode').val();
                if(mobile == '' || mobile == undefined){
                    new axMessage({
                        content: '请输入手机号',
                        result: 'error',
                        iconShow:true,
                    }).show();
                    return;
                }
                if(imgcode == '' || imgcode == undefined){
                    new axMessage({
                        content: '请输入图形验证码',
                        result: 'error',
                        iconShow:true,
                    }).show();
                    return;
                }
                var count = 120;// 短信验证码发送间隔2分钟
                $(this).addClass('ax-disabled');// 按钮禁用                
                $.ajax({
                    url: '<{url c="system" a="sendReq"}>', // 设置请求URL
                    type: "POST", // 指定请求类型为POST
                    dataType: "json", // 设置返回数据格式为JSON
                    contentType: 'application/json', // 设置请求头中Content-Type字段值为'application/json'
                    data: JSON.stringify({"api":"/api/auth/sendMobileCode","method":"post","mobile":mobile,"validateCode":imgcode}), // 将要发送的数据转换成JSON字符串并作为参数传递
                    success: function (response) {
                        if(response.status/1 == 0){
                            new axMessage({
                                content: response.msg,
                                result: 'success',
                                iconShow:true,
                            }).show();
                            const countDown = setInterval(() => {
                                if(count == 0){
                                    // 倒计时完成，按钮文本重置
                                    $('.sendCode').text("重新发送").removeClass('ax-disabled')
                                    clearInterval(countDown);
                                }else{
                                    $('.sendCode').text('('+count + ')秒后可重新获取')
                                }
                                count--;
                                //console.log(count)
                            },1000)
                        }else{
                            new axMessage({
                                content: response.msg,
                                result: 'error',
                                iconShow:true,
                            }).show();
                            $('.sendCode').removeClass('ax-disabled')
                        }
                    },
                    error: function () {
                        new axMessage({
                            content: '发送验证码失败，请联系技术人员！',
                            result: 'error',
                            iconShow:true,
                        }).show();
                        $(this).removeClass('ax-disabled')
                    }
                });
            })
            $('.mobileLogin').click(function(){
                var mobile = $('#mobile').val();
                var imgcode = $('#imgcode').val();
                var code = $('#code').val();
                if(mobile == '' || mobile == undefined){
                    new axMessage({
                        content: '请输入手机号',
                        result: 'error',
                        iconShow:true,
                    }).show();
                    return;
                }
                if(imgcode == '' || imgcode == undefined){
                    new axMessage({
                        content: '请输入图形验证码',
                        result: 'error',
                        iconShow:true,
                    }).show();
                    return;
                }
                if(code == '' || code == undefined){
                    new axMessage({
                        content: '请输入手机验证码',
                        result: 'error',
                        iconShow:true,
                    }).show();
                    return;
                }
                $.ajax({
                    url: '<{url c="system" a="sendReq"}>', // 设置请求URL
                    type: "POST", // 指定请求类型为POST
                    dataType: "json", // 设置返回数据格式为JSON
                    contentType: 'application/json', // 设置请求头中Content-Type字段值为'application/json'
                    data: JSON.stringify({"api":"/api/auth/signByMobile","method":"post","code":code,"mobile":mobile,"validateCode":imgcode}), // 将要发送的数据转换成JSON字符串并作为参数传递
                    success: function (response) {
                        if(response.status/1 == 0){
                            new axMessage({
                                content: response.msg,
                                result: 'success',
                                iconShow:true,
                            }).show();
                            $.cookie('cmpp_token', response.data.token, {expires: 30,path:'/'});
                            $.cookie('cmpp_user', JSON.stringify(response.data), {expires: 30,path:'/'});
                            
                            location.href='<{url c="main" a="index"}>';
                        }else{
                            new axMessage({
                                content: response.msg,
                                result: 'error',
                                iconShow:true,
                            }).show();
                        }
                    },
                    error: function () {
                        new axMessage({
                            content: '登录失败，请联系技术人员！',
                            result: 'error',
                            iconShow:true,
                        }).show();
                        $(this).removeClass('ax-disabled')
                    }
                });
            })
                
            
        })
    </script>
</body>

</html>